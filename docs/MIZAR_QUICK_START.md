# Mizar Backend Quick Start Guide

## Installation

### Prerequisites

1. **Mizar System** (optional, for verification):
   ```bash
   # Download from http://mizar.org
   # Or use package manager:
   sudo apt-get install mizar  # Debian/Ubuntu
   ```

2. **Environment Variables**:
   ```bash
   export MIZFILES=/usr/local/share/mizar
   ```

3. **ECHIDNA**:
   ```bash
   cd /home/user/echidna
   cargo build --release
   ```

## Basic Usage

### 1. Parse a Mizar File

```rust
use echidna::provers::{ProverFactory, ProverKind, ProverConfig};
use std::path::PathBuf;

#[tokio::main]
async fn main() -> anyhow::Result<()> {
    // Create backend
    let config = ProverConfig::default();
    let backend = ProverFactory::create(ProverKind::Mizar, config)?;

    // Parse file
    let proof_state = backend.parse_file(
        PathBuf::from("proofs/mizar/basic.miz")
    ).await?;

    println!("Parsed {} goals", proof_state.goals.len());
    println!("Loaded {} theorems", proof_state.context.theorems.len());

    Ok(())
}
```

### 2. Search MML Theorems

```rust
let results = backend.search_theorems("intersection").await?;
for theorem in results.iter().take(5) {
    println!("  {}", theorem);
}
```

### 3. Apply Tactics

```rust
use echidna::core::Tactic;

// Introduce a variable
let state = backend.apply_tactic(
    &proof_state,
    &Tactic::Intro(Some("x".to_string()))
).await?;

// Apply a theorem
let state = backend.apply_tactic(
    &state,
    &Tactic::Apply("XBOOLE_0:1".to_string())
).await?;
```

### 4. Verify a Proof

```rust
// Complete all goals first
// ...

if backend.verify_proof(&completed_state).await? {
    println!("✓ Proof verified!");
} else {
    println!("✗ Verification failed");
}
```

### 5. Export to Mizar

```rust
let mizar_code = backend.export(&proof_state).await?;
println!("{}", mizar_code);

// Output:
// :: Generated by ECHIDNA
// environ
//   vocabularies SUBSET_1, XBOOLE_0, TARSKI;
//   ...
// begin
// theorem Th1:
//   for P being set holds P = P
// proof
//   thus thesis;
// end;
```

## Example Mizar Files

### Basic Theorem

```mizar
environ
 vocabularies SUBSET_1, XBOOLE_0, TARSKI;
 notations TARSKI, XBOOLE_0;
 constructors TARSKI, XBOOLE_0;
 registrations XBOOLE_0;

begin

theorem Reflexivity:
  for P being set holds P = P
proof
  let P be set;
  thus P = P;
end;
```

### With Case Analysis

```mizar
theorem PerCasesExample:
  for X, Y being set holds
    X \/ Y = Y \/ X
proof
  let X, Y be set;
  thus X \/ Y c= Y \/ X
  proof
    let x be object;
    assume x in X \/ Y;
    then x in X or x in Y by XBOOLE_0:def 3;
    per cases;
    suppose x in X;
      hence x in Y \/ X by XBOOLE_0:def 3;
    end;
    suppose x in Y;
      hence x in Y \/ X by XBOOLE_0:def 3;
    end;
  end;
  thus Y \/ X c= X \/ Y;  :: symmetric case
end;
```

## Common Patterns

### Proving Equality

```mizar
theorem SetEquality:
  for A, B being set holds
    A = B iff A c= B & B c= A
proof
  let A, B be set;
  thus A = B implies A c= B & B c= A proof ... end;
  thus A c= B & B c= A implies A = B by XBOOLE_0:def 10;
end;
```

### Using Justifications

```mizar
theorem WithJustification:
  for X being set holds X /\ X = X
proof
  let X be set;
  thus X /\ X c= X
  proof
    let x be object;
    assume x in X /\ X;
    then x in X & x in X by XBOOLE_0:def 4;  :: Reference to MML
    hence x in X;
  end;
  thus X c= X /\ X proof ... end;
end;
```

## API Reference

### ProverBackend Methods

```rust
// Get prover kind
backend.kind() -> ProverKind

// Get version
backend.version().await? -> String

// Parse from file
backend.parse_file(path: PathBuf).await? -> ProofState

// Parse from string
backend.parse_string(content: &str).await? -> ProofState

// Apply tactic
backend.apply_tactic(&state, &tactic).await? -> TacticResult

// Verify proof
backend.verify_proof(&state).await? -> bool

// Export to Mizar
backend.export(&state).await? -> String

// Get tactic suggestions
backend.suggest_tactics(&state, limit).await? -> Vec<Tactic>

// Search theorems
backend.search_theorems(pattern: &str).await? -> Vec<String>
```

### Tactic Types

```rust
// Standard tactics
Tactic::Apply(theorem_name)        // Apply theorem
Tactic::Intro(optional_name)       // Introduce variable
Tactic::Cases(term)                // Case analysis
Tactic::Assumption                 // Use hypothesis
Tactic::Exact(term)                // Exact proof term

// Mizar-specific tactics
Tactic::Custom {
    prover: "mizar".to_string(),
    command: "thus".to_string(),   // or "hence", "per_cases"
    args: vec![],
}
```

## Error Handling

```rust
use anyhow::Context;

let result = backend.parse_file(path)
    .await
    .context("Failed to parse Mizar file")?;

// Errors include:
// - Parse errors (line/column information)
// - Verification errors (from mizf/verifier)
// - IO errors (file not found, etc.)
// - Term conversion errors
```

## Performance Tips

1. **Batch Operations**: Parse multiple files in parallel:
   ```rust
   let futures: Vec<_> = files.iter()
       .map(|f| backend.parse_file(f.clone()))
       .collect();
   let results = futures::future::try_join_all(futures).await?;
   ```

2. **Caching**: Cache parsed MML articles for faster theorem search

3. **Timeouts**: Configure appropriate timeouts for verification:
   ```rust
   let mut config = ProverConfig::default();
   config.timeout = 600;  // 10 minutes
   ```

## Debugging

### Enable Logging

```rust
use tracing_subscriber;

tracing_subscriber::fmt::init();

// Now backend operations will log:
// [INFO] Parsing Mizar file: basic.miz
// [DEBUG] Found 10 theorems
// [INFO] Running mizf accommodation...
```

### Inspect ProofState

```rust
println!("Goals: {:#?}", proof_state.goals);
println!("Context: {:#?}", proof_state.context);
println!("Proof Script: {:#?}", proof_state.proof_script);
```

### Export for Manual Verification

```rust
let mizar_code = backend.export(&proof_state).await?;
std::fs::write("debug.miz", mizar_code)?;

// Then manually run:
// $ mizf debug.miz
// $ verifier debug.miz
```

## Testing

### Run Tests

```bash
# All tests
cargo test

# Mizar-specific tests
cargo test mizar

# With output
cargo test mizar -- --nocapture
```

### Add Custom Tests

```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[tokio::test]
    async fn test_my_theorem() {
        let content = r#"
environ
 vocabularies XBOOLE_0;
begin

theorem MyTheorem:
  for X being set holds X = X
proof
  let X be set;
  thus X = X;
end;
"#;

        let config = ProverConfig::default();
        let backend = MizarBackend::new(config);

        let state = backend.parse_string(content).await.unwrap();
        assert_eq!(state.context.theorems.len(), 1);
        assert_eq!(state.context.theorems[0].name, "MyTheorem");
    }
}
```

## Common Issues

### Issue: "mizf not found"

**Solution**: Install Mizar system or set executable path:
```rust
let mut config = ProverConfig::default();
config.executable = PathBuf::from("/usr/local/bin/verifier");
```

### Issue: "MIZFILES not set"

**Solution**: Set environment variable:
```bash
export MIZFILES=/usr/local/share/mizar
```

Or in code:
```rust
let backend = MizarBackend::new(config)
    .with_mml_path(PathBuf::from("/path/to/mizar/mml"));
```

### Issue: Parse errors

**Solution**: Check Mizar syntax, especially:
- Semicolons after statements
- `begin` after `environ`
- Proper `proof ... end;` structure
- Correct operator syntax (`\/` not `∪`)

## Resources

- **Mizar Homepage**: http://mizar.org
- **MML Browser**: http://mizar.org/version/current/html/
- **Mizar Tutorial**: http://mizar.org/project/bibliography.html
- **ECHIDNA Docs**: /home/user/echidna/docs/
- **Full Backend Docs**: /home/user/echidna/docs/MIZAR_BACKEND.md

## Examples

All examples are in `/home/user/echidna/proofs/mizar/`:

- **basic.miz** - Simple theorems for beginners
- **propositional.miz** - Propositional logic theorems
- **numbers.miz** - Natural number arithmetic

Run them:
```rust
let backend = ProverFactory::create(ProverKind::Mizar, config)?;
let state = backend.parse_file(
    PathBuf::from("proofs/mizar/basic.miz")
).await?;
```

---

**For More Information**: See `/home/user/echidna/docs/MIZAR_BACKEND.md`
